{% extends "base.html" %}
{% block title %}Analytics{% endblock %}
{% block header_title %}Advanced Analytics{% endblock %}

{% block extra_head %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/heatmap.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<style>
/* ═══════════════════════════════════════════════════════════════
   ANALYTICS PAGE — solid, vivid, background-proof
   Key principle: every surface uses a solid dark base + blur so
   the rainbow animation CANNOT bleed through.
   ═══════════════════════════════════════════════════════════════ */

/* ── Layout ───────────────────────────────────────────────────── */
.an-grid-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}
@media (max-width: 900px) { .an-grid-2 { grid-template-columns: 1fr; } }

/* Solid card — no transparency bleed */
.an-card {
    background: #0f1e35;                        /* solid dark navy */
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 18px;
    padding: 24px 26px;
    overflow: hidden;
    box-shadow: 0 4px 32px rgba(0,0,0,0.45);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
}
.an-card.full { grid-column: 1 / -1; }

.an-card h3 {
    margin: 0 0 5px 0;
    font-size: 15px;
    font-weight: 700;
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 9px;
}
.an-card h3 i { color: #0ef0c8; font-size: 14px; }

.an-subtitle {
    font-size: 12px;
    color: rgba(255,255,255,0.55);
    margin: 0 0 18px 0;
}

/* ── Period filter chips ──────────────────────────────────────── */
.an-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 22px;
}
.an-chip {
    padding: 7px 18px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    border: 1.5px solid rgba(255,255,255,0.22);
    color: rgba(255,255,255,0.75);
    background: #0f1e35;
    cursor: pointer;
    transition: all 0.18s;
    text-decoration: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.an-chip:hover {
    background: rgba(14,240,200,0.15);
    border-color: rgba(14,240,200,0.55);
    color: #0ef0c8;
}
.an-chip.active {
    background: rgba(14,240,200,0.18);
    border-color: #0ef0c8;
    color: #0ef0c8;
    box-shadow: 0 0 12px rgba(14,240,200,0.25);
}

/* ── KPI Strip ────────────────────────────────────────────────── */
.an-kpi-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 22px;
}
.an-kpi {
    flex: 1;
    min-width: 120px;
    padding: 16px 20px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.18);
    background: #0f1e35;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    backdrop-filter: blur(10px);
}
.an-kpi .kv {
    font-size: 32px;
    font-weight: 900;
    line-height: 1;
    letter-spacing: -0.5px;
    text-shadow: 0 0 20px currentColor;
}
.an-kpi .kl {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.55);
    margin-top: 7px;
}

/* Vivid KPI colors with glow */
.kpi-teal  { color: #0ef0c8; }
.kpi-amber { color: #fbbf24; }
.kpi-red   { color: #f87171; }
.kpi-blue  { color: #60a5fa; }

/* ── At-risk table ────────────────────────────────────────────── */
.risk-table {
    width: 100%;
    border-collapse: collapse;
}
.risk-table th {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.55);
    padding: 10px 14px;
    text-align: left;
    border-bottom: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.03);
}
.risk-table td {
    padding: 12px 14px;
    font-size: 13px;
    color: #f0f4f8;
    border-bottom: 1px solid rgba(255,255,255,0.07);
    vertical-align: middle;
}
.risk-table tr:last-child td { border-bottom: none; }
.risk-table tr:hover td { background: rgba(255,255,255,0.05); }

.risk-bar-wrap {
    width: 90px;
    height: 6px;
    background: rgba(255,255,255,0.12);
    border-radius: 3px;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
    margin-right: 8px;
}
.risk-bar { height: 100%; border-radius: 3px; }

.risk-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 0.05em;
}
.rb-critical {
    background: rgba(239,68,68,0.25);
    color: #fca5a5;
    border: 1px solid rgba(239,68,68,0.4);
}
.rb-warning {
    background: rgba(251,191,36,0.2);
    color: #fde68a;
    border: 1px solid rgba(251,191,36,0.4);
}
.rb-watch {
    background: rgba(96,165,250,0.18);
    color: #93c5fd;
    border: 1px solid rgba(96,165,250,0.35);
}

/* ── Absentee leaderboard ─────────────────────────────────────── */
.lb-row {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 11px 0;
    border-bottom: 1px solid rgba(255,255,255,0.08);
}
.lb-row:last-child { border-bottom: none; }
.lb-rank {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 900;
    flex-shrink: 0;
}
.rank-1 {
    background: rgba(251,191,36,0.25);
    color: #fbbf24;
    border: 1.5px solid rgba(251,191,36,0.6);
    box-shadow: 0 0 8px rgba(251,191,36,0.3);
}
.rank-2 {
    background: rgba(200,210,220,0.18);
    color: #cbd5e1;
    border: 1.5px solid rgba(200,210,220,0.4);
}
.rank-3 {
    background: rgba(205,127,80,0.22);
    color: #fb923c;
    border: 1.5px solid rgba(205,127,80,0.45);
}
.rank-n {
    background: rgba(255,255,255,0.07);
    color: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.15);
}

.lb-name { flex: 1; font-size: 13px; font-weight: 700; color: #f1f5f9; }
.lb-bar-wrap {
    width: 100px;
    height: 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
    overflow: hidden;
}
.lb-bar {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, #ef4444, #f97316);
    box-shadow: 0 0 6px rgba(239,68,68,0.4);
}
.lb-pct {
    font-size: 13px;
    font-weight: 800;
    width: 40px;
    text-align: right;
    flex-shrink: 0;
}

/* ── Student selector ─────────────────────────────────────────── */
.an-student-sel {
    padding: 9px 34px 9px 13px;
    background: rgba(255,255,255,0.10);
    border: 1.5px solid rgba(255,255,255,0.28);
    border-radius: 9px;
    color: #f8fafc;
    font-size: 13px;
    font-weight: 600;
    font-family: inherit;
    outline: none;
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 11 11'%3E%3Cpath fill='%23f8fafc' d='M5.5 7L1 2h9z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    transition: border-color 0.2s;
}
.an-student-sel option { background: #0f1e35; color: #f8fafc; }
.an-student-sel:focus {
    border-color: #0ef0c8;
    box-shadow: 0 0 0 3px rgba(14,240,200,0.15);
}

/* ── Prediction note ──────────────────────────────────────────── */
.predict-note {
    font-size: 11px;
    color: rgba(255,255,255,0.45);
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
}
</style>
{% endblock %}

{% block content %}

<!-- ── PERIOD SELECTOR ─────────────────────────────────────────── -->
<div class="an-filter-row">
    <a href="/analytics?days=30"  class="an-chip {% if days==30  %}active{% endif %}">30 days</a>
    <a href="/analytics?days=60"  class="an-chip {% if days==60  %}active{% endif %}">60 days</a>
    <a href="/analytics?days=90"  class="an-chip {% if days==90  %}active{% endif %}">90 days</a>
    <a href="/analytics?days=180" class="an-chip {% if days==180 %}active{% endif %}">6 months</a>
    <a href="/analytics?days=365" class="an-chip {% if days==365 %}active{% endif %}">Full year</a>
</div>

<!-- ── KPI STRIP ──────────────────────────────────────────────── -->
<div class="an-kpi-row">
    <div class="an-kpi">
        <div class="kv kpi-teal">{{ kpi.avg_pct }}%</div>
        <div class="kl">Avg Attendance</div>
    </div>
    <div class="an-kpi">
        <div class="kv kpi-amber">{{ kpi.at_risk_count }}</div>
        <div class="kl">At-Risk Students</div>
    </div>
    <div class="an-kpi">
        <div class="kv kpi-red">{{ kpi.critical_count }}</div>
        <div class="kl">Critical (&lt;60%)</div>
    </div>
    <div class="an-kpi">
        <div class="kv kpi-blue">{{ kpi.best_day }}</div>
        <div class="kl">Best Weekday</div>
    </div>
    <div class="an-kpi">
        <div class="kv" style="color:#f87171;">{{ kpi.worst_day }}</div>
        <div class="kl">Worst Weekday</div>
    </div>
    <div class="an-kpi">
        <div class="kv" style="color:#a78bfa;">{{ kpi.total_sessions }}</div>
        <div class="kl">Total Sessions</div>
    </div>
</div>

<!-- ── ROW 1: Class trend + Heatmap ──────────────────────────── -->
<div class="an-grid-2">

    <!-- Class-wide trend -->
    <div class="an-card">
        <h3><i class="fas fa-chart-line"></i> Class Attendance Trend</h3>
        <p class="an-subtitle">Daily class-wide attendance rate — last {{ days }} days</p>
        <div id="classTrendChart" style="height:260px;"></div>
    </div>

    <!-- Heatmap: which weekdays are worst -->
    <div class="an-card">
        <h3><i class="fas fa-th"></i> Weekday Heatmap</h3>
        <p class="an-subtitle">Average attendance % by day of the week</p>
        <div id="weekdayChart" style="height:260px;"></div>
    </div>

</div>

<!-- ── ROW 2: Per-student trend + absentee leaderboard ───────── -->
<div class="an-grid-2">

    <!-- Per-student trend (dropdown) -->
    <div class="an-card">
        <h3><i class="fas fa-user-chart"></i> Per-Student Trend</h3>
        <p class="an-subtitle" style="margin-bottom:12px;">Attendance trajectory over time</p>

        <select class="an-student-sel" id="student-sel" onchange="switchStudent(this.value)">
            {% for s in students %}
            <option value="{{ s.id }}" {% if loop.first %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>

        <div id="studentTrendChart" style="height:240px;margin-top:14px;"></div>
        <div class="predict-note">
            <i class="fas fa-info-circle"></i>
            Dashed line = linear extrapolation of the last 14 days
        </div>
    </div>

    <!-- Top absentees leaderboard -->
    <div class="an-card">
        <h3><i class="fas fa-trophy-alt"></i> Absentee Leaderboard</h3>
        <p class="an-subtitle">Students with lowest attendance this period</p>

        {% if leaderboard %}
        {% for s in leaderboard %}
        <div class="lb-row">
            <div class="lb-rank {{ 'rank-' + loop.index|string if loop.index <= 3 else 'rank-n' }}">
                {{ loop.index }}
            </div>
            <div class="lb-name">{{ s.name }}</div>
            <div class="lb-bar-wrap">
                <div class="lb-bar" style="width:{{ 100 - s.pct }}%;"></div>
            </div>
            <div class="lb-pct" style="color:{% if s.pct < 60 %}#ef4444{% elif s.pct < 75 %}#f59e0b{% else %}#94a3b8{% endif %};">
                {{ s.pct }}%
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div style="text-align:center;padding:30px;color:rgba(255,255,255,0.25);font-size:13px;">
            <i class="fas fa-check-circle" style="font-size:24px;display:block;margin-bottom:10px;color:rgba(16,185,129,0.3);"></i>
            All students above threshold
        </div>
        {% endif %}
    </div>

</div>

<!-- ── ROW 3: At-risk prediction table (full width) ───────────── -->
<div class="an-card full" style="margin-bottom:20px;">
    <h3><i class="fas fa-exclamation-circle"></i> At-Risk Prediction</h3>
    <p class="an-subtitle">
        Based on attendance trajectory — students projected to fall below 75% within 2 weeks
        are flagged even if currently above threshold
    </p>

    {% if at_risk_predictions %}
    <div style="overflow-x:auto;">
    <table class="risk-table">
        <thead>
            <tr>
                <th>Student</th>
                <th>Current %</th>
                <th>Trend (14d)</th>
                <th>Projected 14d</th>
                <th>Consecutive Absences</th>
                <th>Risk Level</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for s in at_risk_predictions %}
            {% if s.pct < 85 or s.consecutive_absences >= 2 %}
            <tr>
                <td style="font-weight:600;">{{ s.name }}</td>
                <td>
                    <span class="risk-bar-wrap">
                        <div class="risk-bar" style="
                            width:{{ s.pct }}%;
                            background:{% if s.pct < 60 %}#ef4444{% elif s.pct < 75 %}#f59e0b{% else %}#63b3ed{% endif %};"></div>
                    </span>
                    <span style="font-size:12px;font-weight:700;
                        color:{% if s.pct < 60 %}#ef4444{% elif s.pct < 75 %}#f59e0b{% else %}#63b3ed{% endif %};">
                        {{ s.pct }}%
                    </span>
                </td>
                <td>
                    <span style="font-size:12px;font-weight:700;
                        color:{% if s.trend < -2 %}#ef4444{% elif s.trend < 0 %}#f59e0b{% else %}#10b981{% endif %};">
                        {% if s.trend > 0 %}↑{% elif s.trend < 0 %}↓{% else %}→{% endif %}
                        {{ s.trend | abs }}%/wk
                    </span>
                </td>
                <td>
                    <span style="font-weight:700;
                        color:{% if s.projected < 60 %}#ef4444{% elif s.projected < 75 %}#f59e0b{% else %}#94a3b8{% endif %};">
                        {{ s.projected }}%
                    </span>
                </td>
                <td>
                    <span style="font-size:12px;
                        color:{% if s.consecutive_absences >= 3 %}#ef4444{% elif s.consecutive_absences >= 2 %}#f59e0b{% else %}rgba(255,255,255,0.4){% endif %};">
                        {% if s.consecutive_absences > 0 %}
                        {{ s.consecutive_absences }} day{{ 's' if s.consecutive_absences != 1 else '' }}
                        {% else %}—{% endif %}
                    </span>
                </td>
                <td>
                    {% if s.pct < 60 or s.projected < 60 %}
                    <span class="risk-badge rb-critical">Critical</span>
                    {% elif s.pct < 75 or s.projected < 75 or s.consecutive_absences >= 3 %}
                    <span class="risk-badge rb-warning">Warning</span>
                    {% else %}
                    <span class="risk-badge rb-watch">Watch</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/report?date={{ today }}" class="btn btn-primary"
                       style="padding:5px 13px;font-size:12px;text-decoration:none;">
                        <i class="fas fa-eye"></i> View
                    </a>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% else %}
    <div style="text-align:center;padding:30px;color:rgba(255,255,255,0.25);font-size:13px;">
        <i class="fas fa-shield-check" style="font-size:28px;display:block;margin-bottom:12px;color:rgba(16,185,129,0.3);"></i>
        No students currently at risk
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
/* ── Highcharts shared theme ──────────────────────────────────────── */
const HC_THEME = {
    chart:   { backgroundColor: 'transparent' },
    title:   { text: null },
    credits: { enabled: false },
    legend:  { itemStyle: { color: '#cbd5e1', fontFamily: 'Plus Jakarta Sans', fontSize: '12px' } },
    tooltip: {
        backgroundColor: '#0a1628',
        borderColor: 'rgba(14,240,200,0.3)',
        borderWidth: 1,
        style: { color: '#f8fafc', fontSize: '13px' },
        shadow: { color: 'rgba(0,0,0,0.6)', blur: 16, offsetX: 0, offsetY: 4 },
    },
    xAxis: {
        labels: { style: { color: '#94a3b8', fontFamily: 'Plus Jakarta Sans', fontSize: '11px' } },
        lineColor:     'rgba(255,255,255,0.15)',
        gridLineColor: 'rgba(255,255,255,0.07)',
        tickColor:     'transparent',
    },
    yAxis: {
        labels: { style: { color: '#94a3b8', fontFamily: 'Plus Jakarta Sans', fontSize: '11px' } },
        gridLineColor: 'rgba(255,255,255,0.10)',
        title: { style: { color: '#94a3b8' } },
    },
};

/* ── 1. Class-wide trend ────────────────────────────────────────── */
const classTrendData  = {{ class_trend_data  | tojson }};
const classTrendLabels= {{ class_trend_labels | tojson }};

Highcharts.chart('classTrendChart', {
    ...HC_THEME,
    chart: { ...HC_THEME.chart, type: 'areaspline' },
    xAxis: { ...HC_THEME.xAxis, categories: classTrendLabels },
    yAxis: { ...HC_THEME.yAxis, min:0, max:100,
             title: { text: 'Attendance %', style: { color: '#94a3b8' } } },
    tooltip: { ...HC_THEME.tooltip, valueSuffix: '%' },
    series: [{
        name: 'Attendance %',
        data: classTrendData,
        color: '#0ef0c8',
        lineWidth: 3,
        marker: { radius: 4, fillColor: '#0ef0c8', lineWidth: 2, lineColor: '#fff' },
        fillColor: {
            linearGradient: { x1:0, y1:0, x2:0, y2:1 },
            stops: [
                [0, 'rgba(14,240,200,0.45)'],
                [0.5, 'rgba(14,240,200,0.15)'],
                [1, 'rgba(14,240,200,0.0)']
            ]
        },
    }],
    legend: { enabled: false },
    plotOptions: { areaspline: { threshold: null } },
});

/* ── 2. Weekday heatmap (bar chart) ─────────────────────────────── */
const weekdayData  = {{ weekday_data  | tojson }};   // [{name:'Mon', y:82.5}, ...]
const weekdayNames = weekdayData.map(d => d.name);
const weekdayVals  = weekdayData.map(d => ({
    y: d.y,
    color: d.y >= 85 ? '#0ef0c8' :
           d.y >= 75 ? '#38bdf8' :
           d.y >= 60 ? '#f59e0b' : '#f87171'
}));

Highcharts.chart('weekdayChart', {
    ...HC_THEME,
    chart: { ...HC_THEME.chart, type: 'column' },
    xAxis: { ...HC_THEME.xAxis, categories: weekdayNames },
    yAxis: { ...HC_THEME.yAxis, min:0, max:100,
             title: { text: 'Avg %', style: { color: '#94a3b8' } },
             plotLines: [{
                 value: 75,
                 color: 'rgba(239,68,68,0.7)',
                 dashStyle: 'Dash',
                 width: 2,
                 label: {
                     text: '75% threshold',
                     style: { color: 'rgba(239,68,68,0.9)', fontSize: '11px', fontWeight: '700' }
                 }
             }]
    },
    tooltip: { ...HC_THEME.tooltip, valueSuffix: '%',
               formatter: function() { return `<b>${this.x}</b>: ${this.y.toFixed(1)}%`; } },
    series: [{
        name: 'Avg Attendance',
        data: weekdayVals,
        borderRadius: 7,
        borderWidth: 0,
    }],
    legend: { enabled: false },
    plotOptions: { column: { pointPadding: 0.08, groupPadding: 0.04 } },
});

/* ── 3. Per-student trend with prediction ───────────────────────── */
const studentTrendAll = {{ student_trend_all | tojson }};
let currentChart = null;

function switchStudent(studentId) {
    const data = studentTrendAll[studentId];
    if (!data) return;
    renderStudentChart(data);
}

function renderStudentChart(data) {
    if (currentChart) { try { currentChart.destroy(); } catch(e){} }

    // Build prediction line: linear regression on last min(14, len) points
    const actual = data.actual || [];
    const labels = data.labels || [];
    const nPts   = Math.min(14, actual.length);
    let predSeries = null;

    if (nPts >= 3) {
        const sub = actual.slice(-nPts);
        const xs  = sub.map((_, i) => i);
        const n   = xs.length;
        const sx  = xs.reduce((a,b)=>a+b,0);
        const sy  = sub.reduce((a,b)=>a+b,0);
        const sxy = xs.reduce((a,i)=>a+i*sub[i],0);
        const sx2 = xs.reduce((a,i)=>a+i*i,0);
        const slope = (n*sxy - sx*sy) / (n*sx2 - sx*sx) || 0;
        const intercept = (sy - slope*sx) / n;

        // Project 7 more days
        const extLen = 7;
        const predData = Array(actual.length - nPts).fill(null).concat(
            sub.map((_, i) => parseFloat((intercept + slope*i).toFixed(1))),
            Array.from({length: extLen}, (_, i) =>
                parseFloat(Math.max(0, Math.min(100, intercept + slope*(nPts+i))).toFixed(1))
            )
        );
        const predLabels = [...labels, ...Array.from({length:extLen}, (_, i) => `+${i+1}d`)];

        predSeries = {
            name: 'Projected',
            data: predData,
            dashStyle: 'ShortDot',
            color: '#fbbf24',
            lineWidth: 2.5,
            marker: { enabled: false },
            enableMouseTracking: true,
        };
    }

    const series = [{
        name: 'Attendance %',
        data: actual,
        color: '#0ef0c8',
        lineWidth: 3,
        marker: { radius: 4, fillColor: '#0ef0c8', lineWidth: 2, lineColor: '#fff' },
        fillColor: {
            linearGradient: { x1:0, y1:0, x2:0, y2:1 },
            stops: [
                [0,   'rgba(14,240,200,0.45)'],
                [0.5, 'rgba(14,240,200,0.15)'],
                [1,   'rgba(14,240,200,0.0)']
            ]
        },
        type: 'areaspline',
    }];
    if (predSeries) series.push(predSeries);

    currentChart = Highcharts.chart('studentTrendChart', {
        ...HC_THEME,
        xAxis: { ...HC_THEME.xAxis, categories: data.labels },
        yAxis: { ...HC_THEME.yAxis, min:0, max:100,
                 title: { text: '%', style: { color: '#64748b' } },
                 plotLines: [{ value:75, color:'rgba(239,68,68,0.35)', dashStyle:'Dash', width:1 }] },
        tooltip: { ...HC_THEME.tooltip, valueSuffix: '%', shared: true },
        series: series,
        legend: { enabled: predSeries != null,
                  itemStyle: { color: '#94a3b8', fontFamily: 'Plus Jakarta Sans', fontSize: '11px' } },
        plotOptions: { areaspline: { threshold: null } },
    });
}

// Render first student on load
(function() {
    const sel = document.getElementById('student-sel');
    if (sel && studentTrendAll[sel.value]) {
        renderStudentChart(studentTrendAll[sel.value]);
    }
})();
</script>
{% endblock %}