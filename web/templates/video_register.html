<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Face — {{ student_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
    .reg-page {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    /* ── Header ── */
    .reg-header {
        height: 64px;
        padding: 0 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(10,16,40,0.7);
        border-bottom: 1px solid var(--glass-border);
        flex-shrink: 0;
    }
    .reg-header h2 {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .reg-header h2 i { color: var(--accent-orange); }

    /* ── Body ── */
    .reg-body {
        flex: 1;
        display: flex;
        gap: 0;
        overflow: hidden;
    }

    /* ── Camera column ── */
    .reg-cam-col {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px 20px 24px 30px;
    }
    .reg-video-wrap {
        position: relative;
        border-radius: 18px;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        max-width: 640px;
        width: 100%;
        aspect-ratio: 4/3;
        background: #0a1020;
    }
    .reg-video-wrap img {
        width: 100%; height: 100%;
        object-fit: cover;
        display: block;
    }

    /* ── Side panel ── */
    .reg-panel {
        width: 300px;
        flex-shrink: 0;
        background: rgba(15,23,42,0.75);
        backdrop-filter: blur(12px);
        border-left: 1px solid var(--glass-border);
        display: flex;
        flex-direction: column;
        padding: 24px 20px;
        gap: 20px;
        overflow-y: auto;
    }

    .panel-section h4 {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        margin-bottom: 12px;
    }

    /* ── Overall progress ── */
    .overall-progress {
        text-align: center;
    }
    .prog-ring-wrap {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 0 auto 12px;
    }
    .prog-ring-wrap svg {
        transform: rotate(-90deg);
    }
    .prog-ring-bg  { fill: none; stroke: rgba(255,255,255,0.08); stroke-width: 8; }
    .prog-ring-fill {
        fill: none;
        stroke: var(--accent-orange);
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.4s ease;
    }
    .prog-ring-text {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .prog-ring-text .big   { font-size: 22px; font-weight: 700; color: var(--text-primary); }
    .prog-ring-text .small { font-size: 11px; color: var(--text-muted); }

    /* ── Phase cards ── */
    .phase-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--glass-border);
        background: rgba(255,255,255,0.04);
        transition: all 0.3s ease;
        margin-bottom: 8px;
    }
    .phase-card.active {
        border-color: var(--accent-orange);
        background: rgba(255,155,68,0.08);
    }
    .phase-card.done {
        border-color: rgba(16,185,129,0.4);
        background: rgba(16,185,129,0.06);
    }
    .phase-icon {
        width: 36px; height: 36px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
        background: rgba(255,255,255,0.06);
        color: var(--text-muted);
        transition: 0.3s;
    }
    .phase-card.active .phase-icon { background: var(--accent-orange); color: white; }
    .phase-card.done   .phase-icon { background: #10b981; color: white; }

    .phase-info { flex: 1; min-width: 0; }
    .phase-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 3px;
    }
    .phase-mini-bar {
        height: 4px;
        border-radius: 4px;
        background: rgba(255,255,255,0.08);
        overflow: hidden;
    }
    .phase-mini-fill {
        height: 100%;
        border-radius: 4px;
        background: var(--accent-orange);
        transition: width 0.35s ease;
    }
    .phase-card.done .phase-mini-fill { background: #10b981; }
    .phase-frames {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 3px;
    }

    /* ── Feedback box ── */
    .feedback-box {
        padding: 12px 14px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
        min-height: 48px;
        border: 1px solid var(--glass-border);
        background: rgba(255,255,255,0.04);
    }
    .feedback-box.ok {
        border-color: rgba(16,185,129,0.4);
        background: rgba(16,185,129,0.08);
        color: #10b981;
    }
    .feedback-box.warn {
        border-color: rgba(255,155,68,0.4);
        background: rgba(255,155,68,0.08);
        color: var(--accent-orange);
    }
    .feedback-box.error {
        border-color: rgba(239,68,68,0.4);
        background: rgba(239,68,68,0.08);
        color: #ef4444;
    }

    /* ── Done overlay ── */
    .done-overlay {
        display: none;
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.75);
        backdrop-filter: blur(8px);
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 12px;
        border-radius: 16px;
        z-index: 10;
        text-align: center;
        padding: 20px;
    }
    .done-overlay.show { display: flex; }
    .done-check {
        width: 64px; height: 64px;
        background: #10b981;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 28px;
        animation: popIn 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
    }
    @keyframes popIn {
        from { transform: scale(0); }
        to   { transform: scale(1); }
    }
    .done-overlay h3 { font-size: 20px; font-weight: 700; color: white; margin: 0; }
    .done-overlay p  { font-size: 14px; color: rgba(255,255,255,0.6); margin: 0; }

    /* ── Processing spinner ── */
    .processing-bar {
        display: none;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        background: rgba(255,155,68,0.08);
        border: 1px solid rgba(255,155,68,0.3);
        border-radius: 12px;
        font-size: 13px;
        color: var(--accent-orange);
    }
    .processing-bar.show { display: flex; }
    .spin-icon { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 800px) {
        .reg-body    { flex-direction: column; }
        .reg-panel   { width: 100%; height: 200px; border-left: none; border-top: 1px solid var(--glass-border); flex-direction: row; overflow-x: auto; }
        .reg-cam-col { padding: 16px; }
    }
    </style>
</head>

<body style="margin:0;background:var(--bg-dark,#050913);display:flex;flex-direction:column;height:100vh;overflow:hidden;">

<div class="rainbow-wrapper">
    {% for i in range(4) %}<div class="rainbow"></div>{% endfor %}
    <div class="h"></div><div class="v"></div>
</div>

<div class="sidebar" style="position:fixed;top:0;left:0;height:100vh;z-index:20;">
    <div class="brand"><i class="fas fa-fingerprint"></i><span>Smart</span>Attend</div>
    <ul class="menu">
        <li><a href="/"><i class="fas fa-th-large"></i> Dashboard</a></li>
        <li><a href="/students"><i class="fas fa-users"></i> Students</a></li>
        <li><a href="#" class="active"><i class="fas fa-user-plus"></i> Register</a></li>
    </ul>
</div>

<div class="reg-page" style="margin-left:260px;">

    <!-- Header -->
    <div class="reg-header">
        <h2>
            <i class="fas fa-user-plus"></i>
            Smart Face Registration —
            <span style="color:var(--accent-orange);margin-left:4px;">{{ student_name }}</span>
        </h2>
        <a href="/students" class="btn btn-primary"
           style="background:rgba(255,255,255,0.07);padding:8px 18px;font-size:13px;">
            <i class="fas fa-arrow-left"></i> Cancel
        </a>
    </div>

    <!-- Body -->
    <div class="reg-body">

        <!-- Camera -->
        <div class="reg-cam-col">
            <div class="reg-video-wrap">
                <img id="regStream"
                     src="{{ url_for('register_feed', student_name=student_name) }}"
                     alt="Registration camera">

                <!-- Done overlay (shown by JS) -->
                <div class="done-overlay" id="doneOverlay">
                    <div class="done-check"><i class="fas fa-check" style="color:white;"></i></div>
                    <h3>All Frames Captured!</h3>
                    <p>Building face embeddings...<br>You'll be redirected automatically.</p>
                </div>
            </div>
        </div>

        <!-- Panel -->
        <div class="reg-panel">

            <!-- Overall progress ring -->
            <div class="panel-section overall-progress">
                <h4>Overall Progress</h4>
                <div class="prog-ring-wrap">
                    <svg viewBox="0 0 100 100" width="100" height="100">
                        <circle class="prog-ring-bg"  cx="50" cy="50" r="42"/>
                        <circle class="prog-ring-fill" id="progRing"
                                cx="50" cy="50" r="42"
                                stroke-dasharray="263.9"
                                stroke-dashoffset="263.9"/>
                    </svg>
                    <div class="prog-ring-text">
                        <span class="big"  id="progNum">0</span>
                        <span class="small" id="progDen">/15</span>
                    </div>
                </div>
            </div>

            <!-- Phase cards -->
            <div class="panel-section">
                <h4>Capture Phases</h4>
                <div id="phase-0" class="phase-card active">
                    <div class="phase-icon"><i class="fas fa-dot-circle"></i></div>
                    <div class="phase-info">
                        <div class="phase-name">Front</div>
                        <div class="phase-mini-bar">
                            <div class="phase-mini-fill" id="fill-0" style="width:0%"></div>
                        </div>
                        <div class="phase-frames" id="frames-0">0 / 5 frames</div>
                    </div>
                </div>
                <div id="phase-1" class="phase-card">
                    <div class="phase-icon"><i class="fas fa-arrow-left"></i></div>
                    <div class="phase-info">
                        <div class="phase-name">Turn Left</div>
                        <div class="phase-mini-bar">
                            <div class="phase-mini-fill" id="fill-1" style="width:0%"></div>
                        </div>
                        <div class="phase-frames" id="frames-1">0 / 5 frames</div>
                    </div>
                </div>
                <div id="phase-2" class="phase-card">
                    <div class="phase-icon"><i class="fas fa-arrow-right"></i></div>
                    <div class="phase-info">
                        <div class="phase-name">Turn Right</div>
                        <div class="phase-mini-bar">
                            <div class="phase-mini-fill" id="fill-2" style="width:0%"></div>
                        </div>
                        <div class="phase-frames" id="frames-2">0 / 5 frames</div>
                    </div>
                </div>
            </div>

            <!-- Live feedback -->
            <div class="panel-section">
                <h4>Live Feedback</h4>
                <div class="feedback-box warn" id="feedbackBox">
                    <i class="fas fa-info-circle" id="feedbackIcon"></i>
                    <span id="feedbackText">Initialising camera...</span>
                </div>
            </div>

            <!-- Processing indicator -->
            <div class="processing-bar" id="processingBar">
                <i class="fas fa-cog spin-icon"></i>
                Building face embeddings — please wait...
            </div>

        </div><!-- /panel -->
    </div><!-- /body -->
</div>

<script>
const STUDENT_NAME  = "{{ student_name }}";
const FRAMES_NEEDED = 5;
const TOTAL_NEEDED  = 15;
const CIRCUMFERENCE = 263.9;  // 2π × 42

let redirectTimer = null;

function updateRing(saved) {
    const pct    = saved / TOTAL_NEEDED;
    const offset = CIRCUMFERENCE * (1 - pct);
    document.getElementById('progRing').style.strokeDashoffset = offset;
    document.getElementById('progNum').textContent = saved;
}

function setFeedback(text, type) {
    // type: 'ok' | 'warn' | 'error'
    const box  = document.getElementById('feedbackBox');
    const icon = document.getElementById('feedbackIcon');
    const span = document.getElementById('feedbackText');
    box.className  = 'feedback-box ' + type;
    span.textContent = text;
    const icons = { ok: 'fa-check-circle', warn: 'fa-info-circle', error: 'fa-exclamation-triangle' };
    icon.className = 'fas ' + (icons[type] || 'fa-info-circle');
}

function updatePhaseCards(data) {
    for (let i = 0; i < 3; i++) {
        const card  = document.getElementById('phase-' + i);
        const fill  = document.getElementById('fill-' + i);
        const label = document.getElementById('frames-' + i);
        const saved = data.phases[i].saved;
        const done  = data.phases[i].done;

        fill.style.width = Math.min(100, (saved / FRAMES_NEEDED) * 100) + '%';
        label.textContent = saved + ' / ' + FRAMES_NEEDED + ' frames';

        card.classList.remove('active', 'done');
        if (done) {
            card.classList.add('done');
        } else if (i === data.phase_idx) {
            card.classList.add('active');
        }
    }
}

async function poll() {
    try {
        const res  = await fetch('/register_status/' + encodeURIComponent(STUDENT_NAME));
        const data = await res.json();

        if (data.error) return;

        // Ring + counter
        updateRing(data.total_saved);

        // Phase cards
        updatePhaseCards(data);

        // Feedback
        if (data.done) {
            setFeedback('All frames captured! Processing...', 'ok');
            document.getElementById('doneOverlay').classList.add('show');
            document.getElementById('processingBar').classList.add('show');
            document.getElementById('regStream').style.opacity = '0.3';
            // Redirect after 5 seconds (enough time for embeddings)
            if (!redirectTimer) {
                redirectTimer = setTimeout(() => {
                    window.location.href = '/students';
                }, 5000);
            }
            return;  // stop polling
        } else {
            const isGood = data.feedback.startsWith('✓') || data.feedback === 'Good — hold position';
            setFeedback(data.feedback, isGood ? 'ok' : (data.face_visible ? 'warn' : 'error'));
        }

    } catch (e) {
        setFeedback('Camera stream loading...', 'warn');
    }

    setTimeout(poll, 900);
}

// Start polling after short delay
setTimeout(poll, 1200);
</script>
</body>
</html>