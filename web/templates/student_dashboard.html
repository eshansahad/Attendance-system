{% extends "base.html" %}

{% block title %}My Dashboard{% endblock %}
{% block header_title %}My Dashboard{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}

<div class="welcome-banner" style="margin-bottom:24px;">
    <div class="user-avatar orange">
        <i class="fas fa-user-graduate"></i>
    </div>
    <div class="welcome-text">
        <h3>Hello, {{ student_name }}!</h3>
        <p>Here's your attendance summary.</p>
    </div>
</div>

{% if stats.below_threshold %}
<div class="alert-warning">
    <i class="fas fa-exclamation-triangle"></i>
    <div>
        <strong>Low Attendance Warning</strong>
        <p>Your attendance is {{ stats.percentage }}%, which is below the required
           {{ stats.threshold|int }}%. Please attend more classes to avoid issues.</p>
    </div>
</div>
{% endif %}

<div class="stats-grid" style="margin-bottom:28px;">
    <div class="card" style="border-left:4px solid #10b981;">
        <span>Present</span>
        <h4 style="color:#10b981;">{{ stats.present }}</h4>
    </div>
    <div class="card" style="border-left:4px solid #f59e0b;">
        <span>Late</span>
        <h4 style="color:#f59e0b;">{{ stats.late }}</h4>
    </div>
    <div class="card" style="border-left:4px solid #ef4444;">
        <span>Absent</span>
        <h4 style="color:#ef4444;">{{ stats.absent }}</h4>
    </div>
    <div class="card attendance-card">
        <span>Overall</span>
        <div class="percentage-text"
             style="color:{% if stats.below_threshold %}#ef4444{% else %}#ff9b44{% endif %};">
            {{ stats.percentage }}%
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width:{{ stats.percentage }}%;
                 background:{% if stats.below_threshold %}linear-gradient(90deg,#ef4444,#f97316){% else %}linear-gradient(90deg,#ff9b44,#03a9f4){% endif %};">
            </div>
        </div>
        <p class="muted-text">{{ stats.total }} school day{{ stats.total != 1 and "s" or "" }} tracked</p>
    </div>
</div>

<div class="student-grid">

    <!-- Calendar -->
    <div>
        <div class="table-card">

            <!-- Header with navigation -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
                <h3 style="margin:0;"><i class="fas fa-calendar-alt"></i> {{ month_year }}</h3>

                <div style="display:flex;gap:8px;align-items:center;">
                    <!-- Prev month -->
                    <a href="/student_dashboard?year={{ prev_year }}&month={{ prev_month }}"
                       class="cal-nav-btn" title="Previous month">
                        <i class="fas fa-chevron-left"></i>
                    </a>

                    <!-- Month + Year dropdowns -->
                    <form method="GET" action="/student_dashboard"
                          style="display:flex;gap:6px;align-items:center;">
                        <select name="month" onchange="this.form.submit()"
                                style="padding:5px 10px;border-radius:8px;
                                       background:rgba(255,255,255,0.06);
                                       border:1px solid var(--glass-border);
                                       color:var(--text-primary);
                                       font-family:inherit;font-size:13px;cursor:pointer;">
                            {% for m in range(1, 13) %}
                            <option value="{{ m }}" {% if m == current_month %}selected{% endif %}>
                                {{ month_names[m-1] }}
                            </option>
                            {% endfor %}
                        </select>
                        <select name="year" onchange="this.form.submit()"
                                style="padding:5px 10px;border-radius:8px;
                                       background:rgba(255,255,255,0.06);
                                       border:1px solid var(--glass-border);
                                       color:var(--text-primary);
                                       font-family:inherit;font-size:13px;cursor:pointer;">
                            {% for y in year_range %}
                            <option value="{{ y }}" {% if y == current_year %}selected{% endif %}>
                                {{ y }}
                            </option>
                            {% endfor %}
                        </select>
                    </form>

                    <!-- Next month -->
                    <a href="/student_dashboard?year={{ next_year }}&month={{ next_month }}"
                       class="cal-nav-btn" title="Next month">
                        <i class="fas fa-chevron-right"></i>
                    </a>

                    <!-- Back to today -->
                    <a href="/student_dashboard" class="cal-nav-btn" title="Go to today"
                       style="font-size:11px;padding:6px 10px;width:auto;border-radius:8px;">
                        Today
                    </a>
                </div>
            </div>

            <!-- Legend -->
            <div class="cal-legend">
                <span><span class="cal-dot present"></span> Present</span>
                <span><span class="cal-dot late"></span> Late</span>
                <span><span class="cal-dot absent"></span> Absent</span>
                <span><span class="cal-dot no-class"></span> No class</span>
                <span><span class="cal-dot future"></span> Upcoming</span>
            </div>

            <!-- Grid -->
            <div class="cal-grid">
                {% for day in ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"] %}
                    <div class="cal-header">{{ day }}</div>
                {% endfor %}

                {% for week in cal_weeks %}
                    {% for cell in week %}
                        {% if cell is none %}
                            <div class="cal-cell empty"></div>
                        {% else %}
                            <div class="cal-cell {{ cell.status }}"
                                 title="{{ cell.date }} â€“ {{ cell.status|capitalize }}">
                                {{ cell.day }}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>

        </div>
    </div>

    <!-- Right column -->
    <div>
        <div class="table-card sticky-card" style="margin-bottom:24px;">
            <h3><i class="fas fa-chart-pie"></i> Breakdown</h3>
            {% if stats.total > 0 %}
            <div style="position:relative;width:100%;max-width:220px;margin:0 auto;">
                <canvas id="donutChart"></canvas>
                <div class="donut-center-label">
                    <span>{{ stats.percentage }}%</span>
                    <small>attended</small>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <span>No attendance data yet.</span>
            </div>
            {% endif %}
        </div>

        <div class="table-card">
            <h3><i class="fas fa-history"></i> Recent Check-ins</h3>
            {% if recent %}
            <table style="font-size:13px;">
                <thead>
                    <tr><th>Date</th><th>Time</th><th>Status</th></tr>
                </thead>
                <tbody>
                    {% for r in recent %}
                    <tr>
                        <td>{{ r["date"] }}</td>
                        <td>{{ r["time"][:5] }}</td>
                        <td>
                            {% if r["status"] == "Present" %}
                                <span class="badge badge-present">Present</span>
                            {% elif r["status"] == "Late" %}
                                <span class="badge badge-late">Late</span>
                            {% else %}
                                <span class="badge badge-absent">{{ r["status"] }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-check"></i>
                <span>No records yet.</span>
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
{% if stats.total > 0 %}
new Chart(document.getElementById('donutChart').getContext('2d'), {
    type: 'doughnut',
    data: {
        labels: ['Present', 'Late', 'Absent'],
        datasets: [{
            data: [{{ stats.present }}, {{ stats.late }}, {{ stats.absent }}],
            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
            borderWidth: 0,
            hoverOffset: 6
        }]
    },
    options: {
        cutout: '72%',
        plugins: {
            legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 14,
                font: { family: 'Plus Jakarta Sans', size: 12 } } },
            tooltip: { backgroundColor: '#0f172a', titleColor: '#f8fafc', bodyColor: '#94a3b8' }
        }
    }
});
{% endif %}
</script>
{% endblock %}