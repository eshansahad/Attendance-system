{% extends "base.html" %}

{% block title %}Student Dashboard - Smart Attend{% endblock %}
{% block header_title %}Student Dashboard{% endblock %}

{% block content %}
<div class="student-layout">

    <!-- Stats -->
    <div class="stats-grid">
        <div class="card">
            <h4>{{ my_attendance|length }}</h4>
            <span>Days Present</span>
        </div>

        <div class="card">
            <h4>{{ my_issues|length }}</h4>
            <span>Issues Reported</span>
        </div>
    </div>
    
    <!-- Attendance Percentage -->
    <div class="card attendance-card">
        <h3>Attendance Percentage</h3>

        {% set total_days = my_attendance|length %}
        {% set percentage = (total_days * 100) if total_days > 0 else 0 %}

        <div class="percentage-text">
            {{ percentage }}%
        </div>

        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ percentage }}%;"></div>
        </div>

        <p class="muted-text">
            Based on recorded attendance
        </p>
    </div>

    <!-- Attendance Streak -->
    <div class="card">
        <h3>Attendance Streak</h3>

        {% set streak = my_attendance|length %}
        <div class="percentage-text">
            ðŸ”¥ {{ streak }} Days
        </div>

        <p class="muted-text">
            Continuous attendance
        </p>
    </div>

    <!-- Main Grid -->
    <div class="student-grid">

        <!-- LEFT COLUMN -->
        <div>

            <!-- My Reports Status -->
            <div class="table-card">
                <h3><i class="fas fa-history"></i> My Reports Status</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Issue Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% if my_issues %}
                        {% for issue in my_issues %}
                        <tr>
                            <td>{{ issue.date }}</td>
                            <td>{{ issue.type }}</td>
                            <td>
                                {% if issue.status == 'Resolved' %}
                                    <span class="green">Approved</span>
                                {% elif issue.status == 'Rejected' %}
                                    <span style="color:#ef4444;">Rejected</span>
                                {% else %}
                                    <span style="color:#fbbf24;">Pending</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3">
                                <div class="empty-state">
                                    <i class="fas fa-check-circle"></i>
                                    <span>No issues reported yet</span>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Attendance Trend -->
            <div class="table-card">
                <h3><i class="fas fa-chart-line"></i> My Attendance Trend</h3>
                <div id="studentAttendanceChart" style="height:300px;"></div>

                {% if not my_attendance %}
                <div class="empty-state">
                    <i class="fas fa-chart-line"></i>
                    <span>Attendance graph will appear once attendance is marked</span>
                </div>
                {% endif %}
            </div>

            <!-- Attendance History -->
            <div class="table-card">
                <h3><i class="fas fa-calendar-check"></i> Attendance History</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in my_attendance %}
                        <tr>
                            <td>{{ row.date }}</td>
                            <td>{{ row.time }}</td>
                            <td class="green">Present</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="3">
                                <div class="empty-state">
                                    <i class="fas fa-calendar-times"></i>
                                    <span>No attendance records found</span>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div>
            <div class="card sticky-card">
                <h3>Report an Issue</h3>
                <p class="muted-text">
                    Marked absent incorrectly? Let the teacher know.
                </p>

                <form action="/student/report_issue" method="POST">
                    <label>Issue Type</label>
                    <select name="issue_type">
                        <option value="Missing Attendance">Marked absent by mistake</option>
                        <option value="Tech Error">System / Camera Error</option>
                    </select>

                    <label>Description</label>
                    <textarea name="description" rows="4" required></textarea>

                    <button type="submit" class="btn btn-primary full-btn">
                        Submit Report
                    </button>
                </form>
            </div>
        </div>

    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://code.highcharts.com/highcharts.js"></script>

<script>
    const dates = [
        {% for row in my_attendance %}
            "{{ row.date }}",
        {% endfor %}
    ];

    const values = dates.map(() => 1); // 1 = Present

    if (dates.length > 0) {
        Highcharts.chart('studentAttendanceChart', {
            chart: {
                type: 'column',
                backgroundColor: 'transparent'
            },
            title: { text: null },
            xAxis: {
                categories: dates,
                labels: { style: { color: '#94a3b8' } }
            },
            yAxis: {
                title: { text: 'Days Present' },
                visible: false
            },
            tooltip: { pointFormat: '<b>Present</b>' },
            series: [{
                name: 'Attendance',
                data: values,
                color: '#10b981'
            }],
            credits: { enabled: false }
        });
    }
</script>
{% endblock %}
