{% extends "base.html" %}
{% block title %}Teacher Dashboard{% endblock %}
{% block header_title %}Teacher Dashboard{% endblock %}

{% block content %}

<!-- Welcome -->
<div class="welcome-banner">
    <div class="user-avatar orange">
        <i class="fas fa-chalkboard-teacher"></i>
    </div>
    <div class="welcome-text">
        <h3>Welcome back, {{ session.user_name or "Teacher" }}!</h3>
        <p>
            {{ attendance|length }} student{{ attendance|length != 1 and "s" or "" }} present today
            {% if intruders %} &nbsp;·&nbsp; <span style="color:#ef4444;">{{ intruders|length }} security alert{{
                intruders|length != 1 and "s" or "" }}</span>{% endif %}
        </p>
    </div>
    <a href="/start_camera" class="btn btn-primary">
        <i class="fas fa-camera"></i> Start Attendance
    </a>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="card">
        <span>Present Today</span>
        <h4>{{ attendance|length }}</h4>
    </div>
    <div class="card" style="border-left:4px solid #f59e0b;">
        <span>Late Today</span>
        <h4>{{ attendance|selectattr("status","equalto","Late")|list|length }}</h4>
    </div>
    <div class="card danger">
        <span>Security Alerts</span>
        <h4>{{ intruders|length }}</h4>
    </div>
    <div class="card" style="border-left:4px solid #ef4444;">
        <span>At-Risk Students</span>
        <h4>{{ at_risk|length }}</h4>
    </div>
</div>

<!-- ── TODAY'S CLASS SCHEDULE ──────────────────────────────────────────── -->
{% if today_schedule %}
<div class="table-card" style="border-left:4px solid #0ef0c8;margin-bottom:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;
                margin-bottom:16px;flex-wrap:wrap;gap:10px;">
        <h3 style="margin:0;display:flex;align-items:center;gap:8px;">
            <i class="fas fa-calendar-day" style="color:#0ef0c8;"></i>
            Today's Schedule
        </h3>
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            {% if active_session_now and active_session_now != 'General' %}
            <span style="
                display:inline-flex;align-items:center;gap:6px;
                font-size:12px;font-weight:700;color:#0ef0c8;
                background:rgba(14,240,200,0.1);
                border:1px solid rgba(14,240,200,0.25);
                border-radius:20px;padding:5px 14px;">
                <span style="
                    width:7px;height:7px;border-radius:50%;
                    background:#0ef0c8;box-shadow:0 0 7px #0ef0c8;
                    animation:tsPulse 1.5s ease-in-out infinite;
                    flex-shrink:0;display:inline-block;"></span>
                Active: {{ active_session_now }}
            </span>
            {% endif %}
            <a href="/timetable" style="
                font-size:12px;color:rgba(255,255,255,0.4);
                text-decoration:none;display:inline-flex;align-items:center;gap:5px;">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:10px;">
        {% for p in today_schedule %}
        <div
            style="
            display:flex;align-items:center;gap:10px;
            padding:11px 16px;border-radius:12px;
            min-width:155px;flex:1;
            background:{% if p.status=='active' %}rgba(14,240,200,0.08){% elif p.status=='upcoming' %}rgba(255,155,68,0.07){% else %}rgba(255,255,255,0.03){% endif %};
            border:1px solid {% if p.status=='active' %}rgba(14,240,200,0.32){% elif p.status=='upcoming' %}rgba(255,155,68,0.28){% else %}rgba(255,255,255,0.08){% endif %};">

            <span style="
                width:9px;height:9px;border-radius:50%;flex-shrink:0;
                background:{% if p.status=='active' %}#0ef0c8{% elif p.status=='upcoming' %}#ff9b44{% else %}rgba(255,255,255,0.2){% endif %};
                {% if p.status=='active' %}box-shadow:0 0 8px #0ef0c8;animation:tsPulse 1.5s ease-in-out infinite;{% endif %}
                display:inline-block;">
            </span>

            <div style="flex:1;min-width:0;">
                <div style="
                    font-size:13px;font-weight:700;
                    color:{% if p.status=='active' %}#0ef0c8{% elif p.status=='upcoming' %}#ff9b44{% else %}rgba(255,255,255,0.35){% endif %};
                    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                    {{ p.subject_name }}
                </div>
                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px;
                            display:flex;align-items:center;gap:6px;">
                    {{ p.start_time }}–{{ p.end_time }}
                    {% if p.status == 'active' %}
                    <span style="background:rgba(14,240,200,0.2);color:#0ef0c8;
                                 font-size:9px;font-weight:800;border-radius:4px;
                                 padding:1px 5px;letter-spacing:0.06em;">LIVE</span>
                    {% elif p.status == 'upcoming' %}
                    <span style="color:rgba(255,155,68,0.8);font-size:9px;font-weight:700;">NEXT</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<!-- No timetable set up yet — show a subtle prompt -->
<div style="
    background:rgba(14,240,200,0.04);
    border:1px dashed rgba(14,240,200,0.2);
    border-radius:14px;
    padding:16px 22px;
    margin-bottom:24px;
    display:flex;align-items:center;gap:12px;">
    <i class="fas fa-calendar-alt" style="color:rgba(14,240,200,0.4);font-size:18px;"></i>
    <span style="font-size:13px;color:rgba(255,255,255,0.4);">
        No timetable configured.
    </span>
    <a href="/timetable" style="
        margin-left:auto;font-size:12px;font-weight:600;
        color:#0ef0c8;text-decoration:none;
        background:rgba(14,240,200,0.1);
        border:1px solid rgba(14,240,200,0.25);
        border-radius:8px;padding:5px 12px;">
        Set up Timetable →
    </a>
</div>
{% endif %}

<style>
    @keyframes tsPulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.4;
        }
    }
</style>

<!-- 7-day Attendance Trend -->
<div class="table-card">
    <h3><i class="fas fa-chart-line"></i> Attendance Trend – Last 7 Days</h3>
    <div id="attendanceChart" style="height:320px;"></div>
</div>

<!-- ── FULL WEEKLY TIMETABLE ──────────────────────────────────────────────── -->
<style>
    .dash-tt-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        padding: 22px 24px;
        margin-bottom: 24px;
        overflow: hidden;
    }

    .dash-tt-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        gap: 12px;
        flex-wrap: wrap;
    }

    .dash-tt-head h3 {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
        color: #f8fafc;
        display: flex;
        align-items: center;
        gap: 9px;
    }

    .dash-tt-head h3 i {
        color: #0ef0c8;
    }

    .dash-tt-edit-link {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.45);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        transition: 0.2s;
    }

    .dash-tt-edit-link:hover {
        color: #0ef0c8;
        border-color: rgba(14, 240, 200, 0.35);
        background: rgba(14, 240, 200, 0.06);
    }

    .dash-week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        min-width: 600px;
    }

    .dash-day-col {
        display: flex;
        flex-direction: column;
        gap: 7px;
    }

    .dash-day-hdr {
        font-size: 11px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.65);
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.07em;
        padding: 9px 4px;
        border-radius: 9px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .dash-day-hdr.dash-today-col {
        background: rgba(14, 240, 200, 0.15);
        color: #0ef0c8;
        border-color: rgba(14, 240, 200, 0.38);
    }

    .dash-period {
        padding: 9px 10px 9px 12px;
        border-radius: 10px;
        font-size: 12px;
        border-left: 4px solid;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: box-shadow 0.15s, filter 0.15s;
        position: relative;
    }

    .dash-period:hover {
        filter: brightness(1.15);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .dash-period.dp-active {
        box-shadow: 0 2px 12px rgba(14, 240, 200, 0.2);
    }

    .dash-p-subj {
        font-size: 12px;
        font-weight: 700;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 4px;
    }

    .dash-period.dp-active .dash-p-subj {
        color: #0ef0c8;
    }

    .dash-p-time {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 3px;
        font-weight: 500;
    }

    .dash-live-badge {
        position: absolute;
        top: 5px;
        right: 6px;
        font-size: 9px;
        font-weight: 800;
        background: rgba(14, 240, 200, 0.25);
        color: #0ef0c8;
        border-radius: 5px;
        padding: 1px 5px;
        letter-spacing: 0.06em;
    }

    .dash-empty-day {
        text-align: center;
        padding: 14px 4px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.22);
        border: 1px dashed rgba(255, 255, 255, 0.14);
        border-radius: 10px;
    }

    /* colour palette for period blocks */
    .dpc0 {
        border-left-color: #0ef0c8;
        background: rgba(14, 240, 200, 0.12)
    }

    .dpc1 {
        border-left-color: #ff9b44;
        background: rgba(255, 155, 68, 0.14)
    }

    .dpc2 {
        border-left-color: #c084fc;
        background: rgba(192, 132, 252, 0.12)
    }

    .dpc3 {
        border-left-color: #60a5fa;
        background: rgba(96, 165, 250, 0.12)
    }

    .dpc4 {
        border-left-color: #f472b6;
        background: rgba(244, 114, 182, 0.12)
    }

    .dpc5 {
        border-left-color: #34d399;
        background: rgba(52, 211, 153, 0.12)
    }

    .dpc6 {
        border-left-color: #fbbf24;
        background: rgba(251, 191, 36, 0.12)
    }

    .dpc7 {
        border-left-color: #a78bfa;
        background: rgba(167, 139, 250, 0.12)
    }

    .dpc8 {
        border-left-color: #fb923c;
        background: rgba(251, 146, 60, 0.12)
    }

    .dpc9 {
        border-left-color: #22d3ee;
        background: rgba(34, 211, 238, 0.12)
    }
</style>

<div class="dash-tt-card">
    <div class="dash-tt-head">
        <h3><i class="fas fa-calendar-week"></i> Weekly Timetable</h3>
        <a href="/timetable" class="dash-tt-edit-link">
            <i class="fas fa-edit"></i> Edit Timetable
        </a>
    </div>

    {% if timetable %}
    <div style="overflow-x:auto;">
        <div class="dash-week-grid">
            {% set day_names = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
            {% set now_str = '' %}
            {% for d in range(7) %}
            <div class="dash-day-col">
                <div class="dash-day-hdr {% if d == today_dow %}dash-today-col{% endif %}">
                    {{ day_names[d] }}
                    {% if d == today_dow %}<br><span style="font-size:9px;opacity:0.7;">TODAY</span>{% endif %}
                </div>
                {% set day_ps = timetable | selectattr('day_of_week','equalto',d) | sort(attribute='start_time') | list
                %}
                {% if day_ps %}
                {% for p in day_ps %}
                {% set ci = p.subject_id % 10 %}
                {% set is_active = (d == today_dow) and (p.start_time <= today_schedule[0].start_time) if today_schedule
                    else false %} <div
                    class="dash-period dpc{{ ci }} {% if d == today_dow and today_schedule and today_schedule | selectattr('subject_name','equalto',p.subject_name) | selectattr('status','equalto','active') | list %}dp-active{% endif %}">
                    <div class="dash-p-subj" title="{{ p.subject_name }}">{{ p.subject_code or p.subject_name }}</div>
                    <div class="dash-p-time">{{ p.start_time }}–{{ p.end_time }}</div>
                    {% if d == today_dow and today_schedule %}
                    {% set matches = today_schedule | selectattr('subject_name','equalto',p.subject_name) |
                    selectattr('status','equalto','active') | list %}
                    {% if matches %}<span class="dash-live-badge">LIVE</span>{% endif %}
                    {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="dash-empty-day">—</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div style="text-align:center;padding:36px 20px;color:rgba(255,255,255,0.3);">
    <i class="fas fa-calendar-week"
        style="font-size:36px;display:block;margin-bottom:12px;color:rgba(255,255,255,0.1);"></i>
    No periods set up yet. <a href="/timetable" style="color:#0ef0c8;text-decoration:none;">Add periods in the timetable
        →</a>
</div>
{% endif %}
</div>

<!-- At-Risk Students -->
{% if at_risk %}
<div class="table-card" style="border-left:4px solid #ef4444;">
    <h3><i class="fas fa-exclamation-triangle" style="color:#ef4444;"></i>
        Low-Attendance Alerts</h3>
    <p class="muted-text">Students whose attendance has dropped below the configured threshold.</p>
    <table>
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Attendance</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for s in at_risk %}
            <tr>
                <td>{{ s.name }}</td>
                <td style="color:#ef4444;font-weight:600;">{{ s.percentage }}%</td>
                <td>
                    <a href="/report" class="btn btn-primary" style="padding:6px 14px;font-size:13px;">View Report</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Today's Attendance Table -->
<div class="table-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="margin:0;">Today's Attendance</h3>
        <a href="/report" class="btn btn-primary" style="padding:8px 16px;font-size:13px;">
            <i class="fas fa-file-alt"></i> Full Report
        </a>
    </div>
    <table>
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Time In</th>
                <th>Status</th>
                <th>Confidence</th>
            </tr>
        </thead>
        <tbody>
            {% if attendance %}
            {% for row in attendance %}
            <tr>
                <td>{{ row["name"] }}</td>
                <td>{{ row["time"] }}</td>
                <td>
                    {% if row["status"] == "Present" %}
                    <span class="badge badge-present">Present</span>
                    {% elif row["status"] == "Late" %}
                    <span class="badge badge-late">Late</span>
                    {% else %}
                    <span class="badge badge-absent">{{ row["status"] }}</span>
                    {% endif %}
                </td>
                <td class="muted-text">{{ "%.1f"|format(row["confidence"]) }}%</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="4">
                    <div class="empty-state">
                        <i class="fas fa-camera-slash"></i>
                        <span>No attendance recorded yet today.</span>
                        <a href="/start_camera" class="btn btn-primary" style="margin-top:14px;">
                            <i class="fas fa-camera"></i> Start Camera
                        </a>
                    </div>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Security Alerts -->
<div class="table-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3><i class="fas fa-shield-alt"></i> Security Alerts</h3>
        {% if intruders %}
        <a href="/clear_intruders" class="btn btn-primary" style="background:#ef4444;">
            <i class="fas fa-trash"></i> Clear All
        </a>
        {% endif %}
    </div>

    {% if intruders %}
    <div class="security-grid" style="margin-top:16px;">
        {% for intruder in intruders %}
        <div class="intruder-card">
            <img src="{{ url_for('serve_intruder', filename=intruder.filename) }}" alt="Unknown face"
                style="width:100%;border-radius:10px;">
            <p style="text-align:center;font-size:12px;color:#ef4444;margin:6px 0;">UNKNOWN</p>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-shield-alt" style="color:#10b981;"></i>
        <span style="color:#10b981;">No security threats detected.</span>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
    Highcharts.chart('attendanceChart', {
        chart: { type: 'spline', backgroundColor: 'transparent' },
        title: { text: null },
        xAxis: {
            categories: {{ chart_labels | tojson }},
        labels: { style: { color: '#94a3b8', fontFamily: 'Plus Jakarta Sans' } }
    },
        yAxis: {
        min: 0, max: 100,
        title: { text: 'Attendance %', style: { color: '#94a3b8' } },
        gridLineColor: 'rgba(255,255,255,0.06)'
    },
        tooltip: { valueSuffix: '%', backgroundColor: '#0f172a', style: { color: '#f8fafc' } },
        series: [{
            name: 'Attendance',
            data: {{ chart_data | tojson }},
        color: '#ff9b44',
        lineWidth: 3,
        marker: { radius: 5, fillColor: '#ff9b44' }
    }],
        legend: { enabled: false },
        credits: { enabled: false }
});
</script>
{% endblock %}