{% extends "base.html" %}

{% block title %}Teacher Dashboard{% endblock %}
{% block header_title %}Teacher Dashboard{% endblock %}

{% block content %}

<!-- Welcome -->
<div class="welcome-banner">
    <div class="user-avatar orange">
        <i class="fas fa-chalkboard-teacher"></i>
    </div>
    <div class="welcome-text">
        <h3>Welcome back, {{ session.user_name or "Teacher" }}!</h3>
        <p>
            {{ attendance|length }} student{{ attendance|length != 1 and "s" or "" }} present today
            {% if intruders %} &nbsp;·&nbsp; <span style="color:#ef4444;">{{ intruders|length }} security alert{{ intruders|length != 1 and "s" or "" }}</span>{% endif %}
        </p>
    </div>
    <a href="/start_camera" class="btn btn-primary">
        <i class="fas fa-camera"></i> Start Attendance
    </a>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="card">
        <span>Present Today</span>
        <h4>{{ attendance|length }}</h4>
    </div>
    <div class="card" style="border-left:4px solid #f59e0b;">
        <span>Late Today</span>
        <h4>{{ attendance|selectattr("status","equalto","Late")|list|length }}</h4>
    </div>
    <div class="card danger">
        <span>Security Alerts</span>
        <h4>{{ intruders|length }}</h4>
    </div>
    <div class="card" style="border-left:4px solid #ef4444;">
        <span>At-Risk Students</span>
        <h4>{{ at_risk|length }}</h4>
    </div>
</div>

<!-- 7-day Attendance Trend -->
<div class="table-card">
    <h3><i class="fas fa-chart-line"></i> Attendance Trend – Last 7 Days</h3>
    <div id="attendanceChart" style="height:320px;"></div>
</div>

<!-- At-Risk Students (below threshold) -->
{% if at_risk %}
<div class="table-card" style="border-left:4px solid #ef4444;">
    <h3><i class="fas fa-exclamation-triangle" style="color:#ef4444;"></i>
        Low-Attendance Alerts</h3>
    <p class="muted-text">Students whose attendance has dropped below the configured threshold.</p>
    <table>
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Attendance</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for s in at_risk %}
            <tr>
                <td>{{ s.name }}</td>
                <td style="color:#ef4444;font-weight:600;">{{ s.percentage }}%</td>
                <td>
                    <a href="/report" class="btn btn-primary"
                       style="padding:6px 14px;font-size:13px;">View Report</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Today's Attendance Table -->
<div class="table-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="margin:0;">Today's Attendance</h3>
        <a href="/report" class="btn btn-primary" style="padding:8px 16px;font-size:13px;">
            <i class="fas fa-file-alt"></i> Full Report
        </a>
    </div>
    <table>
        <thead>
            <tr>
                <th>Student Name</th>
                <th>Time In</th>
                <th>Status</th>
                <th>Confidence</th>
            </tr>
        </thead>
        <tbody>
        {% if attendance %}
            {% for row in attendance %}
            <tr>
                <td>{{ row["name"] }}</td>
                <td>{{ row["time"] }}</td>
                <td>
                    {% if row["status"] == "Present" %}
                        <span class="badge badge-present">Present</span>
                    {% elif row["status"] == "Late" %}
                        <span class="badge badge-late">Late</span>
                    {% else %}
                        <span class="badge badge-absent">{{ row["status"] }}</span>
                    {% endif %}
                </td>
                <td class="muted-text">{{ "%.1f"|format(row["confidence"]) }}%</td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="4">
                    <div class="empty-state">
                        <i class="fas fa-camera-slash"></i>
                        <span>No attendance recorded yet today.</span>
                        <a href="/start_camera" class="btn btn-primary"
                           style="margin-top:14px;">
                            <i class="fas fa-camera"></i> Start Camera
                        </a>
                    </div>
                </td>
            </tr>
        {% endif %}
        </tbody>
    </table>
</div>

<!-- Security Alerts -->
<div class="table-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3><i class="fas fa-shield-alt"></i> Security Alerts</h3>
        {% if intruders %}
        <a href="/clear_intruders" class="btn btn-primary" style="background:#ef4444;">
            <i class="fas fa-trash"></i> Clear All
        </a>
        {% endif %}
    </div>

    {% if intruders %}
    <div class="security-grid" style="margin-top:16px;">
        {% for intruder in intruders %}
        <div class="intruder-card">
            <img src="{{ url_for('serve_intruder', filename=intruder.filename) }}"
                 alt="Unknown face" style="width:100%;border-radius:10px;">
            <p style="text-align:center;font-size:12px;color:#ef4444;margin:6px 0;">UNKNOWN</p>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-shield-alt" style="color:#10b981;"></i>
        <span style="color:#10b981;">No security threats detected.</span>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
Highcharts.chart('attendanceChart', {
    chart:  { type: 'spline', backgroundColor: 'transparent' },
    title:  { text: null },
    xAxis:  {
        categories: {{ chart_labels | tojson }},
        labels: { style: { color: '#94a3b8', fontFamily: 'Plus Jakarta Sans' } }
    },
    yAxis:  {
        min: 0, max: 100,
        title: { text: 'Attendance %', style: { color: '#94a3b8' } },
        gridLineColor: 'rgba(255,255,255,0.06)'
    },
    tooltip: { valueSuffix: '%', backgroundColor: '#0f172a', style: { color: '#f8fafc' } },
    series: [{
        name:  'Attendance',
        data:  {{ chart_data | tojson }},
        color: '#ff9b44',
        lineWidth: 3,
        marker: { radius: 5, fillColor: '#ff9b44' }
    }],
    legend:  { enabled: false },
    credits: { enabled: false }
});
</script>
{% endblock %}