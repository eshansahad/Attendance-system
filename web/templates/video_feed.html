<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Biometric Scanner — Smart Attend</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
    /* ── CAMERA PAGE LAYOUT ─────────────────────────────────────────── */
    .camera-page {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    /* Header */
    .cam-header {
        height: 70px;
        padding: 0 36px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(10,16,40,0.6);
        border-bottom: 1px solid var(--glass-border);
        flex-shrink: 0;
    }
    .cam-header-left {
        display: flex;
        align-items: center;
        gap: 16px;
    }
    .cam-header h2 {
        font-size: 17px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }
    .cam-header p {
        font-size: 12px;
        color: var(--text-muted);
        margin: 0;
    }

    /* Live dot */
    .live-dot {
        display: flex;
        align-items: center;
        gap: 7px;
        font-size: 12px;
        font-weight: 700;
        color: #10b981;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    .live-dot::before {
        content: '';
        width: 9px; height: 9px;
        background: #10b981;
        border-radius: 50%;
        box-shadow: 0 0 0 0 rgba(16,185,129,0.5);
        animation: livePulse 1.5s ease-out infinite;
    }
    @keyframes livePulse {
        0%  { box-shadow: 0 0 0 0 rgba(16,185,129,0.5); }
        70% { box-shadow: 0 0 0 8px rgba(16,185,129,0); }
        100%{ box-shadow: 0 0 0 0 rgba(16,185,129,0); }
    }

    /* ── BODY SPLIT ─────────────────────────────────────────────────── */
    .cam-body {
        flex: 1;
        display: flex;
        gap: 0;
        overflow: hidden;
    }

    /* ── CAMERA COLUMN ──────────────────────────────────────────────── */
    .cam-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 30px 24px 30px 36px;
        gap: 20px;
    }

    .video-wrapper {
        position: relative;
        border-radius: 20px;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.1);
        box-shadow:
            0 0 0 1px rgba(14,240,200,0.15),
            0 20px 50px rgba(0,0,0,0.5);
        max-width: 680px;
        width: 100%;
        aspect-ratio: 4/3;
        background: #0a1020;
    }

    .video-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* Corner scan lines */
    .scan-corner {
        position: absolute;
        width: 22px; height: 22px;
        border-color: var(--accent-neon);
        border-style: solid;
        border-width: 0;
    }
    .scan-corner.tl { top: 14px; left: 14px;  border-top-width: 2px;    border-left-width: 2px; }
    .scan-corner.tr { top: 14px; right: 14px;  border-top-width: 2px;    border-right-width: 2px; }
    .scan-corner.bl { bottom: 14px; left: 14px;  border-bottom-width: 2px; border-left-width: 2px; }
    .scan-corner.br { bottom: 14px; right: 14px;  border-bottom-width: 2px; border-right-width: 2px; }

    /* Scanning line animation */
    .scan-line {
        position: absolute;
        left: 0; right: 0;
        height: 2px;
        background: linear-gradient(90deg,
            transparent, rgba(14,240,200,0.6), rgba(14,240,200,0.9),
            rgba(14,240,200,0.6), transparent);
        animation: scanMove 3s ease-in-out infinite;
        top: 0;
        box-shadow: 0 0 8px rgba(14,240,200,0.5);
    }
    @keyframes scanMove {
        0%   { top: 0%;   opacity: 0; }
        5%   { opacity: 1; }
        95%  { opacity: 1; }
        100% { top: 100%; opacity: 0; }
    }

    /* Status bar below video */
    .cam-status {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 10px 20px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        width: 100%;
        max-width: 680px;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
    }
    .cam-status-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .cam-status-item i { color: var(--accent-neon); }

    .stop-btn {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        padding: 12px 32px;
        font-size: 14px;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 6px 20px rgba(239,68,68,0.35);
        transition: 0.25s;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-family: inherit;
    }
    .stop-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 28px rgba(239,68,68,0.5);
    }

    /* ── CHECK-INS PANEL ────────────────────────────────────────────── */
    .checkin-panel {
        width: 320px;
        flex-shrink: 0;
        background: rgba(15,23,42,0.7);
        backdrop-filter: blur(12px);
        border-left: 1px solid var(--glass-border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-header {
        padding: 20px 22px 16px;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    .panel-header h3 {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .panel-header h3 i { color: var(--accent-neon); }

    .panel-count {
        background: var(--accent-orange);
        color: white;
        font-size: 12px;
        font-weight: 700;
        padding: 3px 9px;
        border-radius: 20px;
        min-width: 26px;
        text-align: center;
    }

    /* List */
    .checkin-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
    }
    .checkin-list::-webkit-scrollbar { width: 4px; }
    .checkin-list::-webkit-scrollbar-thumb {
        background: var(--glass-border);
        border-radius: 4px;
    }

    /* Individual check-in row */
    .checkin-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.04);
        animation: slideInRight 0.4s cubic-bezier(0.16,1,0.3,1) both;
        transition: background 0.2s;
    }
    .checkin-item:hover {
        background: rgba(255,255,255,0.04);
    }
    @keyframes slideInRight {
        from { opacity: 0; transform: translateX(20px); }
        to   { opacity: 1; transform: translateX(0); }
    }

    .checkin-avatar {
        width: 38px; height: 38px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 15px;
        font-weight: 700;
        flex-shrink: 0;
        color: white;
    }
    .avatar-present { background: linear-gradient(135deg, #10b981, #059669); }
    .avatar-late    { background: linear-gradient(135deg, #f59e0b, #d97706); }

    .checkin-info { flex: 1; min-width: 0; }
    .checkin-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
    }
    .checkin-meta {
        font-size: 11px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .checkin-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
        flex-shrink: 0;
    }
    .checkin-time {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .checkin-conf {
        font-size: 10px;
        color: var(--text-muted);
    }

    /* Empty state */
    .panel-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        color: var(--text-muted);
        font-size: 13px;
        padding: 30px;
        text-align: center;
    }
    .panel-empty i {
        font-size: 32px;
        color: rgba(255,255,255,0.1);
    }

    /* Footer */
    .panel-footer {
        padding: 14px 20px;
        border-top: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    .panel-footer span {
        font-size: 11px;
        color: var(--text-muted);
    }
    .refresh-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 11px;
        color: var(--accent-neon);
    }
    .refresh-indicator i { font-size: 10px; }
    .refresh-indicator.syncing i { animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive — stack on small screens */
    @media (max-width: 860px) {
        .cam-body { flex-direction: column; }
        .checkin-panel { width: 100%; height: 220px; border-left: none; border-top: 1px solid var(--glass-border); }
        .cam-col { padding: 20px; }
    }
    </style>
</head>

<body style="margin:0;background:var(--bg-dark,#050913);display:flex;flex-direction:column;height:100vh;overflow:hidden;">

<!-- Rainbow background (matches rest of app) -->
<div class="rainbow-wrapper">
    {% for i in range(4) %}
        <div class="rainbow"></div>
    {% endfor %}
    <div class="h"></div>
    <div class="v"></div>
</div>

<!-- ── SIDEBAR (minimal, camera context) ────────────────────────────── -->
<div class="sidebar" style="position:fixed;top:0;left:0;height:100vh;z-index:20;">
    <div class="brand">
        <i class="fas fa-fingerprint"></i>
        <span>Smart</span>Attend
    </div>
    <ul class="menu">
        <li>
            <a href="/" onclick="stopCamera(); return false;">
                <i class="fas fa-th-large"></i> Dashboard
            </a>
        </li>
        <li>
            <a href="#" class="active">
                <i class="fas fa-camera"></i> Live Camera
            </a>
        </li>
        <li>
            <a href="/report">
                <i class="fas fa-file-alt"></i> Reports
            </a>
        </li>
    </ul>
</div>

<!-- ── CAMERA PAGE ────────────────────────────────────────────────────── -->
<div class="camera-page" style="margin-left:260px;">

    <!-- Header -->
    <div class="cam-header">
        <div class="cam-header-left">
            <div>
                <h2><i class="fas fa-brain" style="color:var(--accent-neon);margin-right:8px;"></i>AI Biometric Scanner</h2>
                <p>Liveness check active &mdash; please blink to mark attendance</p>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:24px;">
            <div class="live-dot">Live</div>
            <button onclick="stopCamera()" class="stop-btn">
                <i class="fas fa-stop-circle"></i> Stop
            </button>
        </div>
    </div>

    <!-- Body: camera + panel -->
    <div class="cam-body">

        <!-- Camera column -->
        <div class="cam-col">
            <!-- Video frame -->
            <div class="video-wrapper">
                <img id="videoStream"
                     src="{{ url_for('video_feed') }}"
                     alt="Live Camera Feed">
                <!-- Scan corners -->
                <div class="scan-corner tl"></div>
                <div class="scan-corner tr"></div>
                <div class="scan-corner bl"></div>
                <div class="scan-corner br"></div>
                <!-- Scan line -->
                <div class="scan-line"></div>
            </div>

            <!-- Status bar -->
            <div class="cam-status">
                <div class="cam-status-item">
                    <i class="fas fa-shield-alt"></i> Face Mesh Loaded
                </div>
                <div class="cam-status-item">
                    <i class="fas fa-eye"></i> Blink Detection Active
                </div>
                <div class="cam-status-item">
                    <i class="fas fa-lock"></i> Secure Session
                </div>
            </div>
        </div>

        <!-- ── LIVE CHECK-INS PANEL ──────────────────────────────────── -->
        <div class="checkin-panel">
            <div class="panel-header">
                <h3>
                    <i class="fas fa-bolt"></i>
                    Live Check-ins
                </h3>
                <div class="panel-count" id="checkin-count">0</div>
            </div>

            <div id="checkin-list" class="checkin-list">
                <!-- Populated by JS -->
                <div class="panel-empty" id="empty-state">
                    <i class="fas fa-camera"></i>
                    <span>No check-ins yet.<br>Students will appear here as they are recognised.</span>
                </div>
            </div>

            <div class="panel-footer">
                <span id="last-update">Waiting...</span>
                <div class="refresh-indicator" id="refresh-indicator">
                    <i class="fas fa-sync-alt"></i>
                    <span>Live</span>
                </div>
            </div>
        </div>

    </div><!-- /cam-body -->
</div><!-- /camera-page -->

<script>
/* ── STOP CAMERA ─────────────────────────────────────────────────── */
function stopCamera() {
    const img = document.getElementById("videoStream");
    if (img) img.src = "";
    window.location.href = "/";
}

/* ── LIVE CHECK-INS POLLING ─────────────────────────────────────── */
let lastKnownNames = new Set();   // track who's already in the list
let isFirstLoad    = true;

function initials(name) {
    return name.split(' ')
               .map(n => n[0])
               .join('')
               .toUpperCase()
               .slice(0, 2);
}

function timeAgo(timeStr) {
    // timeStr = "HH:MM"
    const [h, m] = timeStr.split(':').map(Number);
    const now  = new Date();
    const then = new Date();
    then.setHours(h, m, 0, 0);
    const diff = Math.floor((now - then) / 60000);
    if (diff < 1)  return 'Just now';
    if (diff < 60) return `${diff}m ago`;
    return `${Math.floor(diff/60)}h ago`;
}

function buildItem(c, isNew) {
    const isLate   = c.status === 'Late';
    const avatarCls = isLate ? 'avatar-late' : 'avatar-present';
    const badgeCls  = isLate ? 'badge-late'  : 'badge-present';

    const div = document.createElement('div');
    div.className = 'checkin-item';
    // Stagger animation for first load
    if (isFirstLoad) div.style.animationDelay = '0s';

    div.innerHTML = `
        <div class="checkin-avatar ${avatarCls}">${initials(c.name)}</div>
        <div class="checkin-info">
            <div class="checkin-name">${c.name}</div>
            <div class="checkin-meta">
                <span class="badge ${badgeCls}" style="padding:1px 7px;font-size:10px;">
                    ${c.status}
                </span>
                <span>${c.session || 'General'}</span>
            </div>
        </div>
        <div class="checkin-right">
            <div class="checkin-time">${c.time}</div>
            <div class="checkin-conf">${c.confidence > 0 ? c.confidence + '%' : '—'}</div>
        </div>
    `;
    return div;
}

function pollCheckins() {
    const indicator = document.getElementById('refresh-indicator');
    indicator.classList.add('syncing');

    fetch('/recent_checkins')
        .then(r => r.json())
        .then(data => {
            indicator.classList.remove('syncing');

            const list      = document.getElementById('checkin-list');
            const emptyEl   = document.getElementById('empty-state');
            const countEl   = document.getElementById('checkin-count');
            const updateEl  = document.getElementById('last-update');

            // Update count badge
            countEl.textContent = data.total || 0;

            // Update timestamp
            const now = new Date();
            updateEl.textContent = `Updated ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

            if (!data.checkins || data.checkins.length === 0) {
                if (emptyEl) emptyEl.style.display = 'flex';
                isFirstLoad = false;
                return;
            }

            // Hide empty state
            if (emptyEl) emptyEl.style.display = 'none';

            // Build set of current names+times (unique key)
            const newKeys = new Set(data.checkins.map(c => c.name + c.time));

            // If this is first load — render all at once
            if (isFirstLoad) {
                list.innerHTML = '';
                data.checkins.forEach(c => {
                    list.appendChild(buildItem(c, false));
                    lastKnownNames.add(c.name + c.time);
                });
                isFirstLoad = false;
                return;
            }

            // Subsequent polls — prepend only NEW entries
            data.checkins.forEach(c => {
                const key = c.name + c.time;
                if (!lastKnownNames.has(key)) {
                    // New check-in — prepend with animation
                    const item = buildItem(c, true);
                    // Insert after panel-empty if it exists, otherwise at top
                    const firstItem = list.querySelector('.checkin-item');
                    if (firstItem) {
                        list.insertBefore(item, firstItem);
                    } else {
                        list.appendChild(item);
                    }
                    lastKnownNames.add(key);

                    // Brief flash on the count badge
                    countEl.style.transform = 'scale(1.3)';
                    setTimeout(() => countEl.style.transform = '', 300);
                }
            });
        })
        .catch(() => {
            indicator.classList.remove('syncing');
        });
}

// Poll immediately then every 2 seconds
pollCheckins();
setInterval(pollCheckins, 2000);
</script>
</body>
</html>